# docker容器网络核心技术讲解

## 容器的网络基础

- [x] 安装docker的时候，会生成一个docker0的虚拟网桥
- [x] Linux虚拟网桥的特点：可以设置ip地址，相当于拥有一个隐藏的虚拟网卡
- [x] 每运行一个docker容器都会生成一个veth设备对，这个veth一个接口在容器里，一个接口在物理机上。

![在这里插入图片描述](https://imgs.ilee.xyz/img/6549afeb39834841b3f61f6c274878ea.png)

安装网桥管理工具：

```
yum install bridge-utils -y
brctl show
```

brctl show 可以查看到有一个docker0的网桥设备，下面有很多接口，每个接口都表示一个启动的docker容器

![img](https://imgs.ilee.xyz/img/8354e40ee87b4e18a4c19a493139830d.png)

## docker 容器的互联

> Centos-vault-8.5.2111.repo可以从阿里云镜像站下载
>
> 也可以从 学习笔记五：dockerfile 构建生产环境镜像 共享的百度网盘查找

```
mkdir ~/dockerfile/inter-image
cd ~/dockerfile/inter-image

cat >dockerfile<<EOF
FROM centos
RUN rm -rf /etc/yum.repos.d/*
COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/
RUN yum install wget -y
RUN yum install nginx -y
RUN sed -i "s/^/#/g" /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD /bin/bash
EOF
```

```
docker build -t="inter-image" .
```

### 允许所有容器间互联（也就是访问）

- [x] 第一种方法

```
# 基于上面的inter-image镜像启动第一个容器test1
docker run --name test1 -itd inter-image

#进入到容器里面启动nginx：
/usr/sbin/nginx
```

```
# 基于上面的inter-image镜像启动第二个容器test2
docker run --name test2 -itd inter-image
```

分别进入到test1容器和test2容器，可以看两个容器的ip，分别是172.17.0.2/16 和172.17.0.5/16

```
docker exec -it test1 /bin/bash
docker exec -it test2 /bin/bash
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/0e47aa12031f4643ab946ed3eb8bff31.png)

在容器test2可以 ping 172.17.0.2 可以看见能ping通test1容器的ip

并且curl 172.17.0.2 能返回nginx界面

![在这里插入图片描述](https://imgs.ilee.xyz/img/8e135ea4be0449bc8318bb5d78f239c4.png)

上述方法假如test1容器重启，那么在启动就会重新分配ip地址，所以为了使ip地址变了也可以访问可以采用link设置网络别名



- [x] 第二种方法：link设置网络别名

可以给容器起一个代号，这样可以直接以代号访问，避免了容器重启ip变化带来的问题

```
docker run --link=[CONTAINER_NAME]:[ALIAS] [IMAGE][COMMAND]

# 启动一个test3容器
docker run --name test3 -itd inter-image /bin/bash

# 启动一个test5容器，–link做链接，那么当我们重新启动test3容器时，就算ip变了，也没关系，我们可以在test5上ping别名webtest
docker run --name test5 -itd --link=test3:webtest inter-image /bin/bash

```

查看test3与test5的IP

![在这里插入图片描述](https://imgs.ilee.xyz/img/2e20a0d29a4c41d58baa8e00a413080a.png)

![在这里插入图片描述](https://imgs.ilee.xyz/img/ea5ca4e1fce146f29b654f7517950176.png)

```
docker exec -it test5 /bin/bash  #进入容器test5
ping test3
ping webtest
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/32d5c3e5d03a4a93865d86294685fe86.png)

## 容器的网络模式

docker run创建Docker容器时，可以用–net选项指定容器的网络模式，Docker有以下4种网络模式：

1. bridge模式：使–net =bridge指定，默认设置；
2. host模式：使–net =host指定；
3. none模式：使–net =none指定；
4. container模式：使用–net =container:NAME orID指定。

### none模式

Docker网络none模式是指创建的容器没有网络地址，只有lo网卡

```
docker run -itd  --name none --net=none --privileged=true centos  
docker exec -it none /bin/bash
ip addr
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/22c7bcb766a241b29f2d1a9d30ee8ae5.png)

### container模式

Docker网络container模式是指，创建新容器的时候，通过–net container参数，指定其和已经存在的某个容器共享一个 Network Namespace。

如下图所示，右方黄色新创建的container，其网卡共享左边容器。因

此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。

![在这里插入图片描述](https://imgs.ilee.xyz/img/faa4cdeb66b149869ecc918059b01be6.png)

和已经存在的none容器共享网络

```
docker run --name container2 --net=container:none  -it --privileged=true centos
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/ad490b231fb1430c810104f8f7c140a3.png)

### bridge模式

默认选择bridge的情况下，容器启动后会通过DHCP获取一个地址

创建桥接网络

```
docker run --name bridge -it  --privileged=true centos  bash
ip a s 
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/06f2a3274156428fb5152a3cf4fb1dd4.png)

### host模式

Docker网络host模式是指共享宿主机的网络

共享宿主机网络

```
docker run --name host -it --net=host --privileged=true centos  bash
ip a s 
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/d0fc9604044c4d61a32418adc66d790e.png)