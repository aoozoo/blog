# 第十章 存放docker镜像的私有仓库harbor安装配置和使用

## Harbor介绍

Docker容器应用的开发和运行离不开可靠的镜像管理，虽然Docker官方也提供了公共的镜像仓库，但是从安全和效率等方面考虑，部署我们私有环境内的Registry也是非常必要的。

Harbor是由VMware公司开源的企业级的Docker Registry管理项目，它包括权限管理(RBAC)、LDAP、日志审核、管理界面、自我注册、镜像复制和中文支持等功能。

官网地址：https://github.com/goharbor/harbor



在Kubernetes中，镜像需要在集群的每个节点上都可用，而不仅仅是在Master节点上。如果您只将镜像上传到Master节点，而没有将其推送到其他节点，那么在执行YAML文件时可能会出现问题。

当您在Kubernetes中部署一个Pod时，Kubernetes会根据Pod的定义选择一个节点来运行该Pod。如果该节点上没有所需的镜像，那么Pod将无法正常启动。



### 实验环境：

安装harbor的机器，主机名设置成harbor

机器需要的内存至少要2G，我分配的是4G

机器ip：192.168.40.181

4vCPU/4G内存/100G硬盘



### **配置SSL证书 （如不做可用http协议）**

```
# 新开台机器配置主机名
hostnamectl set-hostname harbor && bash

# 生成ca证书
mkdir /data/ssl -p
cd /data/ssl/

openssl genrsa -out ca.key 3072 #生成一个3072位的key，也就是私钥
openssl req -new -x509 -days 3650 -key ca.key -out ca.pem

#生成一个数字证书ca.pem，3650表示证书的有效时间是10年，按箭头提示填写即可，没有箭头标注的为空：
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/97325aab22c34c41ba6114f0a3eed41e.png)

生成域名的证书：

```
openssl genrsa -out harbor.key  3072 #生成一个3072位的key，也就是私钥
openssl req -new -key harbor.key -out harbor.csr  
#生成一个证书请求，一会签发证书时需要的，标箭头的按提示填写，没有箭头标注的为空：
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/7442601b5d824ce0bf807a742eb1245e.png)

签发证书：

```
openssl x509 -req -in harbor.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out harbor.pem -days 3650
```

![img](https://imgs.ilee.xyz/img/b5b7a702925b4aa5940bd356a1489513.png)

### 初始化

```
systemctl stop firewalld && systemctl disable firewalld  #关防火墙
cd /etc/yum.repos.d/
mv CentOS-Base.repo CentOS-Base.repo_back
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum install iptables-services -y  #安装iptables
service iptables stop   && systemctl disable iptables  #禁用iptables
iptables -F  #清空防火墙规则
setenforce 0   #关闭selinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config  #修改selinux配置文件之后，重启机器，selinux才能永久生效
yum install -y ntp ntpdate   
ntpdate cn.pool.ntp.org  #配置时间同步
echo '* */1 * * * /usr/sbin/ntpdate   cn.pool.ntp.org' >> /var/spool/cron/root
```

```
systemctl restart crond  #重启crond服务使配置生效：
```

分别在docker服务器和harbor服务器 配置hosts文件

```
rm -rf /etc/hosts
cat >/etc/hosts<<EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.40.180 docker
192.168.40.181 harbor
EOF
```

在harbor服务器安装基础软件包

```
yum install -y  wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack 
```

### 安装docker-ce

配置docker-ce国内yum源（阿里云）

```
yum install -y yum-utils device-mapper-persistent-data lvm2  #安装docker依赖包
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install docker-ce -y   #安装docker-ce
systemctl start docker && systemctl enable docker  #启动服务
systemctl status docker
docker version   
```

开启包转发功能和修改内核参数

内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发。

```
modprobe br_netfilter
cat > /etc/sysctl.d/docker.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
```

/etc/docker/daemon.json

```
{
"registry-mirrors":["https://rsbud4vc.mirror.aliyuncs.com","https://registry.docker-cn.com","https://docker.mirrors.ustc.edu.cn","https://dockerhub.azk8s.cn","http://hub-mirror.c.163.com","http://qtid6917.mirror.aliyuncs.com","https://rncxm540.mirror.aliyuncs.com","https://e9yneuy4.mirror.aliyuncs.com"]
}
```

```
scp /etc/docker/daemon.json 192.168.40.181:/etc/docker/  #在docker这台服务器执行

sysctl -p /etc/sysctl.d/docker.conf
systemctl daemon-reload
systemctl restart docker

```

### 安装Harbor

> 创建安装目录
>
> harbor-offline-installer-v2.3.0-rc3.tgz 文件链接：https://pan.baidu.com/s/1CdkwUVQjQ0HiPwE2uLzBLg?pwd=h5t0
>
> 提取码：h5t0

```
mkdir /data/install -p
cd /data/install/  #安装harbor的文件夹
#把harbor的离线包harbor-offline-installer-v2.3.0-rc3.tgz上传到这个目录
#下载harbor离线包的地址：https://github.com/goharbor/harbor/releases/tag/
```

解压：

```
tar zxvf harbor-offline-installer-v2.3.0-rc3.tgz
cd harbor
cp harbor.yml.tmpl harbor.yml 
```

修改配置文件：

```
vim harbor.yml
#修改hostname，跟上面签发的证书域名保持一致
hostname:  harbor  
#协议用https
certificate: /data/ssl/harbor.pem
private_key: /data/ssl/harbor.key
```

邮件和ldap不需要配置，在harbor的web界面可以配置

其他配置采用默认即可

修改之后保存退出

注：harbor默认的账号密码：`admin/Harbor12345`



### 安装docker-compose

> docker-compose-Linux-x86_64文件 
>
> 链接：https://pan.baidu.com/s/1G1jjNGR_64AMoRjdtE7j1g?pwd=dbir
>
> 提取码：dbir

1. 上传docker-compose-Linux-x86_64文件到harbor机器
2. docker-compose项目是Docker官方的开源项目，负责实现对Docker容器集群的快速编排。Docker-Compose的工程配置文件默认为docker-compose.yml，Docker-Compose运行目录下的必要有一个docker-compose.yml。docker-compose可以管理多个docker实例。
3. 安装harbor需要的离线镜像包 docker-harbor-2-3-0.tar.gz，可上传到harbor机器，通过docker load -i解压

```
cd ..
mv docker-compose-Linux-x86_64.64 /usr/bin/docker-compose
chmod +x /usr/bin/docker-compose
cd /data/install/harbor
docker load -i harbor.v2.3.0.tar.gz
./install.sh
```

出现以下界面就成功了

![在这里插入图片描述](https://imgs.ilee.xyz/img/1185d223bd9f46be89cd322e3a01a882.png)

```shell
[root@harbor harbor]# mv docker-compose-Linux-x86_64.64 /usr/bin/docker-compose
[root@harbor harbor]# chmod +x /usr/bin/docker-compose
[root@harbor harbor]# cd /data/install/harbor
[root@harbor harbor]# docker load -i harbor.v2.3.0.tar.gz
7b63ae3694f2: Loading layer [==================================================>]  36.92MB/36.92MB
b8cb4f2fe042: Loading layer [==================================================>]  8.112MB/8.112MB
Loaded image: goharbor/nginx-photon:v2.3.0
2b6cbbd060e5: Loading layer [==================================================>]  6.186MB/6.186MB
69fc2a5d7057: Loading layer [==================================================>]  4.096kB/4.096kB
421b6d0db9f6: Loading layer [==================================================>]  3.072kB/3.072kB
bc5645ad7d34: Loading layer [==================================================>]  19.02MB/19.02MB
962c38e6d231: Loading layer [==================================================>]  19.81MB/19.81MB
Loaded image: goharbor/registry-photon:v2.3.0
4d82179a9400: Loading layer [==================================================>]  9.914MB/9.914MB
675e2c32eb5d: Loading layer [==================================================>]  3.584kB/3.584kB
8818aef7131e: Loading layer [==================================================>]   2.56kB/2.56kB
9d5d2ed48330: Loading layer [==================================================>]  55.83MB/55.83MB
475c7500b29b: Loading layer [==================================================>]  5.632kB/5.632kB
10e61cefb27a: Loading layer [==================================================>]   93.7kB/93.7kB
f2e373a19887: Loading layer [==================================================>]  11.78kB/11.78kB
f622f2e58e5a: Loading layer [==================================================>]  56.73MB/56.73MB
d220e8c2ccdb: Loading layer [==================================================>]   2.56kB/2.56kB
Loaded image: goharbor/harbor-core:v2.3.0
fa7dc2e6a798: Loading layer [==================================================>]  6.186MB/6.186MB
0f612ded4ff1: Loading layer [==================================================>]  4.096kB/4.096kB
fbb3f0d75fe7: Loading layer [==================================================>]  19.02MB/19.02MB
11c455c1ad44: Loading layer [==================================================>]  3.072kB/3.072kB
5b5dc65c296c: Loading layer [==================================================>]   25.4MB/25.4MB
073cf43e62b3: Loading layer [==================================================>]   45.2MB/45.2MB
Loaded image: goharbor/harbor-registryctl:v2.3.0
b106b5752942: Loading layer [==================================================>]  1.096MB/1.096MB
a10890f8f147: Loading layer [==================================================>]  5.888MB/5.888MB
b7d39d927c0a: Loading layer [==================================================>]  209.2MB/209.2MB
c7b75a8ac758: Loading layer [==================================================>]  15.05MB/15.05MB
685aea1b7e0e: Loading layer [==================================================>]  4.096kB/4.096kB
29eea9e3830a: Loading layer [==================================================>]  6.144kB/6.144kB
6c89dc4abd54: Loading layer [==================================================>]  3.072kB/3.072kB
8f6ddd91b278: Loading layer [==================================================>]  2.048kB/2.048kB
44885e6b8efc: Loading layer [==================================================>]   2.56kB/2.56kB
d0650c47bd17: Loading layer [==================================================>]   2.56kB/2.56kB
baa9d588c87c: Loading layer [==================================================>]   2.56kB/2.56kB
c0948a512263: Loading layer [==================================================>]  8.704kB/8.704kB
Loaded image: goharbor/harbor-db:v2.3.0
230bb4d21843: Loading layer [==================================================>]  9.914MB/9.914MB
3b267db69816: Loading layer [==================================================>]  17.67MB/17.67MB
48f062b756ef: Loading layer [==================================================>]  4.608kB/4.608kB
83cea239dd18: Loading layer [==================================================>]  18.46MB/18.46MB
Loaded image: goharbor/harbor-exporter:v2.3.0
7ce03d8b76bc: Loading layer [==================================================>]  156.8MB/156.8MB
146ee77daba1: Loading layer [==================================================>]  3.072kB/3.072kB
7980207d1d35: Loading layer [==================================================>]   59.9kB/59.9kB
4599e620911a: Loading layer [==================================================>]  61.95kB/61.95kB
Loaded image: goharbor/redis-photon:v2.3.0
e1e5285ecc15: Loading layer [==================================================>]  6.181MB/6.181MB
69fa33ea8a76: Loading layer [==================================================>]  6.207MB/6.207MB
90ecbcead336: Loading layer [==================================================>]  14.89MB/14.89MB
05a6e541d31d: Loading layer [==================================================>]  27.38MB/27.38MB
14d6723ce8f3: Loading layer [==================================================>]  22.02kB/22.02kB
cfe4608e735e: Loading layer [==================================================>]  14.89MB/14.89MB
Loaded image: goharbor/notary-server-photon:v2.3.0
65081183b9d5: Loading layer [==================================================>]  8.112MB/8.112MB
4f1c9ff2daf9: Loading layer [==================================================>]  11.64MB/11.64MB
15070dd6843f: Loading layer [==================================================>]  1.688MB/1.688MB
Loaded image: goharbor/harbor-portal:v2.3.0
3ff2cc3e192a: Loading layer [==================================================>]    161MB/161MB
b39b810a2c31: Loading layer [==================================================>]  3.584kB/3.584kB
bc5176327384: Loading layer [==================================================>]  3.072kB/3.072kB
d178cb37812e: Loading layer [==================================================>]   2.56kB/2.56kB
a0eb93f025fe: Loading layer [==================================================>]  3.072kB/3.072kB
26e033b26702: Loading layer [==================================================>]  3.584kB/3.584kB
0532e71b3bd4: Loading layer [==================================================>]  19.97kB/19.97kB
Loaded image: goharbor/harbor-log:v2.3.0
0cae3dac3e77: Loading layer [==================================================>]  9.914MB/9.914MB
90bebc66effb: Loading layer [==================================================>]  3.584kB/3.584kB
595eefd6fb57: Loading layer [==================================================>]   2.56kB/2.56kB
11c19159aa0f: Loading layer [==================================================>]  62.49MB/62.49MB
5d8a4f259631: Loading layer [==================================================>]  63.28MB/63.28MB
Loaded image: goharbor/harbor-jobservice:v2.3.0
7f36930441df: Loading layer [==================================================>]  6.186MB/6.186MB
f3d478212fb5: Loading layer [==================================================>]  67.47MB/67.47MB
028a02a35dde: Loading layer [==================================================>]  3.072kB/3.072kB
4dd4f408cedc: Loading layer [==================================================>]  4.096kB/4.096kB
6bf984b97419: Loading layer [==================================================>]  68.26MB/68.26MB
Loaded image: goharbor/chartmuseum-photon:v2.3.0
3b9eb50911fc: Loading layer [==================================================>]  41.95MB/41.95MB
a817012987ff: Loading layer [==================================================>]  4.096kB/4.096kB
31d1db570868: Loading layer [==================================================>]  3.072kB/3.072kB
e6eb84749dcb: Loading layer [==================================================>]  31.52MB/31.52MB
6217368c82fa: Loading layer [==================================================>]  11.39MB/11.39MB
91c725a368fd: Loading layer [==================================================>]   43.7MB/43.7MB
Loaded image: goharbor/trivy-adapter-photon:v2.3.0
2c161f748767: Loading layer [==================================================>]  200.4MB/200.4MB
16eef9c7272b: Loading layer [==================================================>]  58.92MB/58.92MB
b86cd0a4d811: Loading layer [==================================================>]   2.56kB/2.56kB
e75da51fe165: Loading layer [==================================================>]  1.536kB/1.536kB
7a60083ed5e2: Loading layer [==================================================>]  12.29kB/12.29kB
b0df2e1cb00e: Loading layer [==================================================>]  2.882MB/2.882MB
27f7dc4873f6: Loading layer [==================================================>]    297kB/297kB
Loaded image: goharbor/prepare:v2.3.0
fe023c4074c2: Loading layer [==================================================>]  6.181MB/6.181MB
64f739adb147: Loading layer [==================================================>]  6.207MB/6.207MB
ae8dd74e5ae3: Loading layer [==================================================>]  13.35MB/13.35MB
f35b97e2a785: Loading layer [==================================================>]  27.38MB/27.38MB
0a1f6bad7db8: Loading layer [==================================================>]  22.02kB/22.02kB
7a5ef06c750b: Loading layer [==================================================>]  13.35MB/13.35MB
Loaded image: goharbor/notary-signer-photon:v2.3.0
[root@harbor harbor]# ./install.sh

[Step 0]: checking if docker is installed ...

Note: docker version: 26.1.4

[Step 1]: checking docker-compose is installed ...

Note: docker-compose version: 1.26.2

[Step 2]: loading Harbor images ...
Loaded image: goharbor/nginx-photon:v2.3.0
Loaded image: goharbor/registry-photon:v2.3.0
Loaded image: goharbor/harbor-core:v2.3.0
Loaded image: goharbor/harbor-registryctl:v2.3.0
Loaded image: goharbor/harbor-db:v2.3.0
Loaded image: goharbor/harbor-exporter:v2.3.0
Loaded image: goharbor/redis-photon:v2.3.0
Loaded image: goharbor/notary-server-photon:v2.3.0
Loaded image: goharbor/harbor-portal:v2.3.0
Loaded image: goharbor/harbor-log:v2.3.0
Loaded image: goharbor/harbor-jobservice:v2.3.0
Loaded image: goharbor/chartmuseum-photon:v2.3.0
Loaded image: goharbor/trivy-adapter-photon:v2.3.0
Loaded image: goharbor/prepare:v2.3.0
Loaded image: goharbor/notary-signer-photon:v2.3.0


[Step 3]: preparing environment ...

[Step 4]: preparing harbor configs ...
prepare base dir is set to /data/install/harbor
Generated configuration file: /config/portal/nginx.conf
Generated configuration file: /config/log/logrotate.conf
Generated configuration file: /config/log/rsyslog_docker.conf
Generated configuration file: /config/nginx/nginx.conf
Generated configuration file: /config/core/env
Generated configuration file: /config/core/app.conf
Generated configuration file: /config/registry/config.yml
Generated configuration file: /config/registryctl/env
Generated configuration file: /config/registryctl/config.yml
Generated configuration file: /config/db/env
Generated configuration file: /config/jobservice/env
Generated configuration file: /config/jobservice/config.yml
Generated and saved secret to file: /data/secret/keys/secretkey
Successfully called func: create_root_cert
Generated configuration file: /compose_location/docker-compose.yml
Clean up the input dir



[Step 5]: starting Harbor ...
Creating network "harbor_harbor" with the default driver
Creating harbor-log ... done
Creating harbor-db     ... done
Creating registry      ... done
Creating redis         ... done
Creating harbor-portal ... done
Creating registryctl   ... done
Creating harbor-core   ... done
Creating harbor-jobservice ... done
Creating nginx             ... done
✔ ----Harbor has been installed and started successfully.----
[root@harbor harbor]# 
```

在自己电脑修改hosts文件

在hosts文件添加如下一行，然后保存即可

192.168.40.181 harbor



### 如何启停harbor：

如果docker-compose start启动harbor之后，还是访问不了，那就需要重启虚拟机

```
cd /data/install/harbor
docker-compose stop
cd /data/install/harbor
docker-compose start
```

### Harbor 图像化界面使用说明

在浏览器输入：https://harbor

![在这里插入图片描述](https://imgs.ilee.xyz/img/91affd17d3244590ba0fd97a7e28e04f.png)

接受风险并继续，出现如下界面，说明访问正常

![在这里插入图片描述](https://imgs.ilee.xyz/img/d4a9a9f845034207b02301213c8edf6e.png)

账号：admin

密码：Harbor12345

输入账号密码出现如下：

![在这里插入图片描述](https://imgs.ilee.xyz/img/838625603aa84fda86b50a5e5b7f56d8.png)

所有基础镜像都会放在library里面，这是一个公开的镜像仓库

新建项目->起个项目名字test（把访问级别公开那个选中，让项目才可以被公开使用）

![在这里插入图片描述](https://imgs.ilee.xyz/img/d3bb0d7fcf9747029b1218ec322e9417.png)

![在这里插入图片描述](https://imgs.ilee.xyz/img/c032cc4ec2b14204b81bce335c82b833.png)

## docker 服务器测试使用harbor私有镜像仓库

```
vim /etc/docker/daemon.json

{  "registry-mirrors": ["https://rsbud4vc.mirror.aliyuncs.com","https://registry.docker-cn.com","https://docker.mirrors.ustc.edu.cn","https://dockerhub.azk8s.cn","http://hub-mirror.c.163.com"],
"insecure-registries": ["192.168.40.181","harbor"]
}
```

增加的内容表示我们内网访问harbor的时候走的是http，192.168.40.181是安装harbor机器的ip

```
systemctl daemon-reload && systemctl restart docker  #修改配置之后使配置生效：
systemctl status docker 
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/3bc64c2d70b847db82dcc4a4f55608e6.png)

### docker服务器镜像上传下载

登录habor 在docker服务器上

```
docker login 192.168.40.181
#Username：admin 
#Password:  Harbor12345
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/4a9f9d3f4f2c42e686406a44b4a529f3.png)

导入tomcat镜像，tomcat.tar.gz

### 上传至harbor

> 链接：https://pan.baidu.com/s/1hWzXl0veZkGgYz-Z9uSfhA?pwd=hziz
>
> 提取码：hziz

1. 先登录，登录后给镜像打标签，打完标签在上传
2. 在本地把tomcat镜像打标签
3. 执行上面命令就会把192.168.40.181/test/tomcat:v1上传到harbor里的test项目下

```
docker load -i tomcat.tar.gz
docker tag tomcat:latest  192.168.40.181/test/tomcat:v1    
docker push 192.168.40.181/test/tomcat:v1
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/b6c8b0173ed748538372ae4f073380ad.png)

![在这里插入图片描述](https://imgs.ilee.xyz/img/d0dc988d57b24c4b91c47ae8dff2b7fb.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/d5520db348c049efbe6b35a0fea6d402.png)

以下报错应该是使用了harbor进行访问

```
denied: requested access to the resource is denied
#建议把harbor更换为IP地址
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/919ebf5b10464088a1e33ad2595f6bb9.png)

![在这里插入图片描述](https://imgs.ilee.xyz/img/f80d6399806143b39fc2cb29845a6814.png)

### 从harbor仓库下载镜像

在docker这台服务器

```
docker rmi -f 192.168.40.11/test/tomcat:v1  #删除该镜像
docker images #查看是否还存在tomcat
docker pull 192.168.40.11/test/tomcat:v1   #拉取镜像
```

![在这里插入图片描述](https://imgs.ilee.xyz/img/20752941f6b14204b93de28a4a770e37.png)

也可以登录后点击拉取，看复制命令行，如果域名报错，还请更换为IP

![在这里插入图片描述](https://imgs.ilee.xyz/img/9389ebbd7936495299a02bde69781c0d.png)